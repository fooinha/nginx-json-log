ngx_addon_name=ngx_json_log_module
ngx_module_incs=$ngx_addon_dir/src

HTTP_JSON_LOG_KAFKA=NO

cat << END > $NGX_AUTOTEST.c

#include <librdkafka/rdkafka.h>

int main(void) {
    rd_kafka_type_t i = 0;
    return (int) i;
}

END

$CC $CC_TEST_FLAGS $CC_AUX_FLAGS -o /dev/null \
  $NGX_AUTOTEST.c $NGX_LD_OPT $ngx_feature_libs 2> /dev/null > /dev/null

if [ $? -eq 0 ]; then
    HTTP_JSON_LOG_KAFKA=YES
fi


NGINX_VERSION=`grep version src/core/nginx.h  | sed 's/#define nginx_version *//;'`

if [ ! -z "${NGINX_VERSION}" ]
then
    if [ $NGINX_VERSION -gt 1011002 ]
    then
        HAS_STREAM_JSON_LOG=true
        STREAM_MODULES="$STREAM_MODULES ngx_stream_json_log_module"
        STREAM_MODULES="$STREAM_MODULES ngx_stream_json_log_preread_module"
        NGX_ADDON_SRCS="$NGX_ADDON_SRCS                           \
         $ngx_addon_dir/src/ngx_stream_json_log_preread_module.c  \
         $ngx_addon_dir/src/ngx_stream_json_log_module.c"
        echo " + ngx_json_log: stream support"
    fi
fi

HTTP_MODULES="$HTTP_MODULES ngx_http_json_log_module"
HTTP_FILTER_MODULES="$HTTP_FILTER_MODULES ngx_http_json_log_filter_module"

CORE_INCS="$CORE_INCS $ngx_module_incs"

NGX_ADDON_SRCS="$NGX_ADDON_SRCS                         \
 $ngx_addon_dir/src/ngx_json_log_str.c                  \
 $ngx_addon_dir/src/ngx_json_log_text.c                 \
 $ngx_addon_dir/src/ngx_json_log_output.c               \
 $ngx_addon_dir/src/ngx_http_json_log_variables.c       \
 $ngx_addon_dir/src/ngx_http_json_log_filter_module.c   \
 $ngx_addon_dir/src/ngx_http_json_log_module.c          \
 "

CORE_LIBS="$CORE_LIBS -ljansson"

if [ $HTTP_JSON_LOG_KAFKA = YES ]; then
    echo " + ngx_json_log: kafka support"
    CFLAGS="$CFLAGS -DHTTP_JSON_LOG_KAFKA_ENABLED"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/src/ngx_json_log_kafka.c"
    CORE_LIBS="$CORE_LIBS -lrdkafka"
fi


